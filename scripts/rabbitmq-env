#!/bin/sh
##  The contents of this file are subject to the Mozilla Public License
##  Version 1.1 (the "License"); you may not use this file except in
##  compliance with the License. You may obtain a copy of the License
##  at http://www.mozilla.org/MPL/
##
##  Software distributed under the License is distributed on an "AS IS"
##  basis, WITHOUT WARRANTY OF ANY KIND, either express or implied. See
##  the License for the specific language governing rights and
##  limitations under the License.
##
##  The Original Code is RabbitMQ.
##
##  The Initial Developer of the Original Code is VMware, Inc.
##  Copyright (c) 2007-2011 VMware, Inc.  All rights reserved.
##

# Determine where this script is really located
SCRIPT_PATH="$0"
while [ -h "$SCRIPT_PATH" ] ; do
    FULL_PATH=`readlink -f $SCRIPT_PATH 2>/dev/null`
    if [ "$?" != "0" ]; then
      REL_PATH=`readlink $SCRIPT_PATH`
      if expr "$REL_PATH" : '/.*' > /dev/null; then
        SCRIPT_PATH="$REL_PATH"
      else
        SCRIPT_PATH="`dirname "$SCRIPT_PATH"`/$REL_PATH"
      fi
    else
      SCRIPT_PATH=$FULL_PATH
    fi
done

SCRIPT_DIR=`dirname $SCRIPT_PATH`
RABBITMQ_HOME="${SCRIPT_DIR}/.."
[ "x" = "x$HOSTNAME" ] && HOSTNAME=`env hostname`
NODENAME=rabbit@${HOSTNAME%%.*}

## Set system default values for rabbitmq-env.conf variables to override
if [ ! -f ${SCRIPT_DIR}/rabbitmq-sys ]; then
    echo -n "WARNING: system defaults are not available -- "
    echo "check the installation completed correctly."
    exit 1
fi

## Get configuration variables from the rabbitmq-env.conf file and rabbitmq-sys
if [ -f /etc/rabbitmq/rabbitmq.conf ] && \
   [ ! -f /etc/rabbitmq/rabbitmq-env.conf ] ; then
    echo -n "WARNING: ignoring /etc/rabbitmq/rabbitmq.conf -- "
    echo "location has moved to /etc/rabbitmq/rabbitmq-env.conf"
fi

if [ -f /etc/rabbitmq/rabbitmq-env.conf ] ; then
    RABBITMQ_ENV_CONF_SETTINGS=`(. ${SCRIPT_DIR}/rabbitmq-sys; \
                                 . /etc/rabbitmq/rabbitmq-env.conf; set;)`
else
    RABBITMQ_ENV_CONF_SETTINGS=`(. ${SCRIPT_DIR}/rabbitmq-sys; set;)`
fi

setRabbitEnvVarWithDefault()
{   # Get value of var $2 from RABBITMQ_ENV_CONF_SETTINGS to set $1, only if $1 is empty
    # $1 - var to set; $2 - var to use from RABBITMQ_ENV_CONF_SETTINGS
    local $2; getRabbitEnvVar $2; applyDefault $1 $2
}
getRabbitEnvVar()
{   # $1 - var to set
    eval `echo "$RABBITMQ_ENV_CONF_SETTINGS" | grep "^$1"`
}
applyDefault()
{   # $1 - var to set; $2 - var with default value
    [ -z "${!1}" ] && eval "$1="'"${!2}"'
}

# use default value of $2 (obtained from RABBITMQ_ENV_CONF_SETTINGS) to set empty value of $1:
setRabbitEnvVarWithDefault RABBITMQ_NODE_IP_ADDRESS      NODE_IP_ADDRESS
setRabbitEnvVarWithDefault RABBITMQ_NODE_PORT            NODE_PORT
setRabbitEnvVarWithDefault RABBITMQ_NODENAME             NODENAME
setRabbitEnvVarWithDefault RABBITMQ_SERVER_ERL_ARGS      SERVER_ERL_ARGS
setRabbitEnvVarWithDefault RABBITMQ_CTL_ERL_ARGS         CTL_ERL_ARGS
setRabbitEnvVarWithDefault RABBITMQ_CONFIG_FILE          CONFIG_FILE
setRabbitEnvVarWithDefault RABBITMQ_LOG_BASE             LOG_BASE
setRabbitEnvVarWithDefault RABBITMQ_MNESIA_BASE          MNESIA_BASE
setRabbitEnvVarWithDefault RABBITMQ_SERVER_START_ARGS    SERVER_START_ARGS
setRabbitEnvVarWithDefault RABBITMQ_MNESIA_DIR           MNESIA_DIR
setRabbitEnvVarWithDefault RABBITMQ_PID_FILE             PID_FILE
setRabbitEnvVarWithDefault RABBITMQ_PLUGINS_EXPAND_DIR   PLUGINS_EXPAND_DIR
setRabbitEnvVarWithDefault RABBITMQ_ENABLED_PLUGINS_FILE ENABLED_PLUGINS_FILE
setRabbitEnvVarWithDefault RABBITMQ_PLUGINS_DIR          PLUGINS_DIR
setRabbitEnvVarWithDefault RABBITMQ_LOGS                 LOGS
setRabbitEnvVarWithDefault RABBITMQ_SASL_LOGS            SASL_LOGS

# dependent default settings:
[ -z "$RABBITMQ_MNESIA_DIR" ]         && RABBITMQ_MNESIA_DIR=${RABBITMQ_MNESIA_BASE}/${RABBITMQ_NODENAME}
[ -z "$RABBITMQ_PID_FILE" ]           && RABBITMQ_PID_FILE=${RABBITMQ_MNESIA_DIR}.pid
[ -z "$RABBITMQ_PLUGINS_EXPAND_DIR" ] && RABBITMQ_PLUGINS_EXPAND_DIR=${RABBITMQ_MNESIA_BASE}/${RABBITMQ_NODENAME}-plugins-expand
[ -z "$RABBITMQ_LOGS" ]               && RABBITMQ_LOGS="${RABBITMQ_LOG_BASE}/${RABBITMQ_NODENAME}.log"
[ -z "$RABBITMQ_SASL_LOGS" ]          && RABBITMQ_SASL_LOGS="${RABBITMQ_LOG_BASE}/${RABBITMQ_NODENAME}-sasl.log"

# inter-dependent defaults not user modifiable:
RABBITMQ_ENV_CONF_SETTINGS=`(. ${SCRIPT_DIR}/rabbitmq-sys; set;)`
[ -n "$RABBITMQ_NODE_PORT" ]          && setRabbitEnvVarWithDefault RABBITMQ_NODE_IP_ADDRESS DEFAULT_NODE_IP_ADDRESS
[ -n "$RABBITMQ_NODE_IP_ADDRESS" ]    && setRabbitEnvVarWithDefault RABBITMQ_NODE_PORT       DEFAULT_NODE_PORT
